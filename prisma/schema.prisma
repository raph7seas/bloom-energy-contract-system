// Bloom Energy Contract Learning & Rules Management System
// Prisma schema for PostgreSQL database

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Contract model
model Contract {
  id            String            @id @default(uuid())
  name          String
  client        String
  site          String
  capacity      Float
  term          Int               // Contract term in years
  systemType    SystemType
  uploadDate    DateTime          @default(now())
  effectiveDate DateTime
  status        ContractStatus    @default(DRAFT)
  totalValue    Float?
  yearlyRate    Float?
  notes         String?
  tags          String[]
  
  // Relationships
  financial     FinancialParams?
  technical     TechnicalParams?
  operating     OperatingParams?
  templates     ContractTemplate[] @relation("TemplateContracts")
  uploads       UploadedFile[]
  documents     ContractDocument[]
  
  // AI Analysis relationships
  analyses      ContractAnalysis[]
  primaryGroups ContractGroup[] @relation("PrimaryContracts")
  groups        ContractGroup[] @relation("GroupContracts")
  classifications DocumentClassification[] @relation("ClassificationSuggestions")
  
  // Metadata
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  createdBy     String?
  updatedBy     String?
  version       Int               @default(1)
  
  @@map("contracts")
}

// Financial Parameters
model FinancialParams {
  id                    String    @id @default(uuid())
  contractId            String    @unique
  contract              Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  baseRate              Float
  microgridAdder        Float?
  escalation            Float     // Annual escalation percentage
  thermalCycleFee       Float?
  electricalBudget      Float?
  commissioningAllowance Float?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@map("financial_parameters")
}

// Technical Parameters
model TechnicalParams {
  id                    String          @id @default(uuid())
  contractId            String          @unique
  contract              Contract        @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  voltage               VoltageLevel
  gridVoltage           VoltageLevel?
  servers               Int
  components            ComponentType[]
  recType               String?
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@map("technical_parameters")
}

// Operating Parameters
model OperatingParams {
  id                    String    @id @default(uuid())
  contractId            String    @unique
  contract              Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  outputWarranty        Float     // Percentage
  efficiency            Float     // Percentage
  minDemand             Float     // kW
  maxDemand             Float     // kW
  criticalOutput        Float     // kW
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@map("operating_parameters")
}

// Contract Templates
model ContractTemplate {
  id            String    @id @default(uuid())
  name          String
  description   String
  category      String
  isActive      Boolean   @default(true)
  
  // Template data stored as JSON
  formData      Json
  
  // Usage tracking
  usageCount    Int       @default(0)
  lastUsed      DateTime?
  
  // Relationships
  contracts     Contract[] @relation("TemplateContracts")
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?
  
  @@map("contract_templates")
}

// File Upload tracking (legacy - maintained for compatibility)
model UploadedFile {
  id            String      @id @default(uuid())
  contractId    String?
  contract      Contract?   @relation(fields: [contractId], references: [id], onDelete: SetNull)

  // Temporary contract ID for uploads before contract is created
  // This field is NOT constrained by foreign key, allowing temp IDs
  tempContractId String?

  fileName      String
  originalName  String
  fileSize      Int         // bytes
  fileType      String      // MIME type
  uploadDate    DateTime    @default(now())
  status        UploadStatus @default(UPLOADING)
  progress      Int         @default(0)

  // Extracted data (JSON)
  extractedData Json?

  // File storage path
  filePath      String?

  // Metadata
  uploadedBy    String?

  @@map("uploaded_files")
}

// Enhanced multi-document support
model ContractDocument {
  id                String              @id @default(uuid())
  contractId        String
  contract          Contract            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  // Document classification
  documentType      DocumentType        @default(PRIMARY)
  sequenceOrder     Int                 @default(0)
  parentDocumentId  String?
  parentDocument    ContractDocument?   @relation("DocumentHierarchy", fields: [parentDocumentId], references: [id], onDelete: SetNull)
  childDocuments    ContractDocument[]  @relation("DocumentHierarchy")
  
  // File information
  title             String
  fileName          String
  originalName      String
  fileSize          Int                 // bytes
  fileType          String              // MIME type
  filePath          String?
  
  // Processing status
  uploadStatus      ProcessingStatus    @default(UPLOADING)
  processingStatus  ProcessingStatus    @default(PENDING)
  uploadProgress    Int                 @default(0)
  processingProgress Int               @default(0)
  
  // Document metrics
  pageCount         Int?
  wordCount         Int?
  totalChunks       Int?                // For chunked uploads
  chunksUploaded    Int                 @default(0)
  
  // Processing metadata
  extractionStarted DateTime?
  extractionCompleted DateTime?
  errorMessage      String?
  processingMetadata Json?
  
  // Relationships
  pages             DocumentPage[]
  chunks            DocumentChunk[]
  
  // AI Analysis relationships
  analyses          ContractAnalysis[]
  sourceSimilarities DocumentSimilarity[] @relation("SourceSimilarities")
  targetSimilarities DocumentSimilarity[] @relation("TargetSimilarities")
  groups            ContractGroup[] @relation("GroupDocuments")
  classification    DocumentClassification?
  
  // Audit
  uploadDate        DateTime            @default(now())
  uploadedBy        String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@map("contract_documents")
}

// Page-level content for large documents
model DocumentPage {
  id                String              @id @default(uuid())
  documentId        String
  document          ContractDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  pageNumber        Int
  extractedText     String?             @db.Text
  confidenceScore   Float?
  wordCount         Int?
  characterCount    Int?
  
  // OCR and processing metadata
  ocrProvider       String?             // 'textract', 'tesseract', etc.
  processingTime    Int?                // milliseconds
  extractionMethod  String?             // 'native_pdf', 'ocr', 'mammoth'
  
  // Page dimensions and layout
  width             Float?
  height            Float?
  rotation          Int?                @default(0)
  
  // Content analysis
  hasTable          Boolean             @default(false)
  hasImage          Boolean             @default(false)
  hasSignature      Boolean             @default(false)
  language          String?             @default("en")
  
  // Processing metadata
  metadata          Json?
  processingStatus  ProcessingStatus    @default(PENDING)
  errorMessage      String?
  
  // Timestamps
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  processedAt       DateTime?
  
  @@unique([documentId, pageNumber])
  @@map("document_pages")
}

// Chunked upload tracking
model DocumentChunk {
  id              String              @id @default(uuid())
  documentId      String
  document        ContractDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  chunkNumber     Int
  chunkSize       Int                 // bytes
  chunkHash       String              // For integrity verification
  uploadStatus    ProcessingStatus    @default(PENDING)
  
  // File storage
  tempFilePath    String?             // Temporary storage during upload
  
  // Upload tracking
  uploadedAt      DateTime?
  retryCount      Int                 @default(0)
  errorMessage    String?
  
  @@unique([documentId, chunkNumber])
  @@map("document_chunks")
}

// Document processing jobs queue
model ProcessingJob {
  id              String              @id @default(uuid())
  jobType         ProcessingJobType
  status          ProcessingStatus    @default(PENDING)
  priority        Int                 @default(5)
  
  // Target entity
  entityType      String              // 'contract_document', 'document_page'
  entityId        String              // ID of the entity to process
  
  // Job configuration
  jobConfig       Json?               // Job-specific configuration
  
  // Progress tracking
  progress        Int                 @default(0)
  totalSteps      Int?
  currentStep     String?
  
  // Timing
  scheduledAt     DateTime            @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  estimatedDuration Int?              // seconds
  
  // Error handling
  retryCount      Int                 @default(0)
  maxRetries      Int                 @default(3)
  errorMessage    String?
  errorDetails    Json?
  
  // Results
  result          Json?
  
  // Metadata
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  createdBy       String?
  
  @@map("processing_jobs")
}

// AI Assistant Messages (for chat history)
model AIMessage {
  id            String    @id @default(uuid())
  sessionId     String    // Group messages by session
  role          AIRole
  content       String
  timestamp     DateTime  @default(now())
  
  // Optional metadata
  metadata      Json?     // For storing additional context
  
  @@map("ai_messages")
}

// Learned Rules for the learning system
model LearnedRule {
  id            String        @id @default(uuid())
  ruleType      RuleType
  category      String        // e.g., "financial", "technical", "operating"
  name          String        // e.g., "capacity_range", "escalation_range"
  
  // Rule data stored as JSON
  ruleData      Json
  
  // Confidence and usage metrics
  confidence    Float         @default(0.0)
  occurrences   Int           @default(1)
  lastSeen      DateTime      @default(now())
  
  // Rule metadata
  isActive      Boolean       @default(true)
  source        String?       // Where the rule was learned from
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@unique([ruleType, category, name])
  @@map("learned_rules")
}

// Audit logging
model AuditLog {
  id            String    @id @default(uuid())
  
  // Entity being audited
  entityType    String    // CONTRACT, LEARNED_RULE, USER, etc.
  entityId      String    // ID of the entity
  
  // Action performed
  action        String    // CREATE, UPDATE, DELETE, VIEW, etc.
  
  // Store old and new values as JSON strings
  oldValues     String?   // JSON string
  newValues     String?   // JSON string
  
  // User context
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Request context
  ipAddress     String?
  userAgent     String?
  metadata      Json      @default("{}")
  
  // Integrity verification
  auditHash     String    // SHA256 hash for integrity
  
  // Timestamp
  timestamp     DateTime  @default(now())
  
  @@map("audit_logs")
}

// Entity versioning for change history
model EntityVersion {
  id                String    @id @default(uuid())
  
  // Entity being versioned
  entityType        String    // CONTRACT, LEARNED_RULE, etc.
  entityId          String    // ID of the entity
  versionNumber     Int       // Sequential version number
  
  // Version data
  data              String    // JSON string of entity state
  changeDescription String?   // Optional description of changes
  versionHash       String    // SHA256 hash for integrity
  
  // Metadata
  createdAt         DateTime  @default(now())
  createdBy         String?
  createdByUser     User?     @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  
  @@unique([entityType, entityId, versionNumber])
  @@map("entity_versions")
}

// System statistics (for dashboard)
model SystemStats {
  id                    String    @id @default(uuid())
  
  totalContracts        Int       @default(0)
  totalValue            Float     @default(0)
  averageContractValue  Float     @default(0)
  monthlyGrowth         Float     @default(0)
  completionRate        Float     @default(0)
  
  // JSON fields for complex stats
  contractsByStatus     Json      @default("{}")
  contractsByType       Json      @default("{}")
  
  // Date this snapshot was taken
  snapshotDate          DateTime  @default(now())
  
  @@map("system_stats")
}

// User Authentication Models
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String    // Hashed password
  firstName     String
  lastName      String
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  
  // Relationships
  sessions          Session[]
  auditLogs         AuditLog[]
  createdVersions   EntityVersion[]
  
  // Audit fields  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

model Session {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String    @unique
  refreshToken  String?   @unique
  expiresAt     DateTime
  isActive      Boolean   @default(true)
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("sessions")
}

// AI Contract Analysis Results
model ContractAnalysis {
  id                    String    @id @default(uuid())
  documentId            String?
  document              ContractDocument? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  contractId            String?
  contract              Contract? @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  // Contract classification
  contractType          String?             // Primary contract type
  contractSubcategory   String?             // More specific type
  contractTypeConfidence Float?             // Confidence score 0-1
  
  // Extracted parties
  parties               Json                // Array of party objects with names, roles, confidence
  partiesConfidence     Float?
  
  // Key dates
  effectiveDate         DateTime?
  expirationDate        DateTime?
  signatureDate         DateTime?
  datesConfidence       Float?
  
  // Financial terms
  totalValue            Float?
  currency              String?
  paymentTerms          String?
  financialConfidence   Float?
  
  // Reference numbers and IDs
  referenceNumbers      Json                // Array of reference objects
  referenceConfidence   Float?
  
  // Subject matter
  description           String?
  keywords              String[]            // Array of keywords
  subjectConfidence     Float?
  
  // Critical clauses
  criticalClauses       Json                // Array of clause objects
  clausesConfidence     Float?
  
  // Overall analysis metadata
  overallConfidence     Float               @default(0.0)
  documentQuality       AnalysisQuality     @default(FAIR)
  analysisNotes         String?
  
  // AI processing metadata
  aiModel               String?             // e.g., "claude-3-sonnet-20240229"
  processingTime        Int?                // milliseconds
  tokenUsage            Json?               // Token usage statistics
  
  // Raw AI response for debugging
  rawResponse           String?             @db.Text
  
  // Relationships
  confidenceTracking    AnalysisConfidence[]

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@map("contract_analyses")
}

// Document similarity and relationships
model DocumentSimilarity {
  id                    String              @id @default(uuid())
  
  // Source and target documents
  sourceDocumentId      String
  sourceDocument        ContractDocument    @relation("SourceSimilarities", fields: [sourceDocumentId], references: [id], onDelete: Cascade)
  targetDocumentId      String
  targetDocument        ContractDocument    @relation("TargetSimilarities", fields: [targetDocumentId], references: [id], onDelete: Cascade)
  
  // Similarity metrics
  overallSimilarity     Float               // 0-1 similarity score
  typeSimilarity        Float?              // Contract type similarity
  partySimilarity       Float?              // Party overlap similarity
  dateSimilarity        Float?              // Date proximity similarity
  contentSimilarity     Float?              // Subject matter similarity
  
  // Relationship classification
  relationshipType      DocumentRelation
  relationshipConfidence Float              @default(0.0)
  
  // Matching factors
  matchingFactors       String[]            // Array of factors that matched
  
  // AI analysis metadata
  analysisDate          DateTime            @default(now())
  aiModel               String?
  analysisNotes         String?
  
  @@unique([sourceDocumentId, targetDocumentId])
  @@map("document_similarities")
}

// Contract grouping for related documents
model ContractGroup {
  id                    String              @id @default(uuid())
  name                  String              // Group name/title
  description           String?             // Group description
  
  // Group classification
  groupType             ContractGroupType   @default(RELATED_CONTRACTS)
  groupReason           String?             // Why documents are grouped together
  
  // Group metadata
  primaryContractId     String?             // Main/primary contract in group
  primaryContract       Contract?           @relation("PrimaryContracts", fields: [primaryContractId], references: [id], onDelete: SetNull)
  
  // Confidence in grouping decision
  groupingConfidence    Float               @default(0.0)
  
  // Relationships
  contracts             Contract[]          @relation("GroupContracts")
  documents             ContractDocument[]  @relation("GroupDocuments")
  
  // Auto-grouping metadata
  autoCreated           Boolean             @default(false)
  createdBy             String?
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  @@map("contract_groups")
}

// Analysis confidence tracking for different aspects
model AnalysisConfidence {
  id                    String              @id @default(uuid())
  analysisId            String
  analysis              ContractAnalysis    @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  // Confidence aspect
  aspectType            ConfidenceAspect    // What aspect this confidence relates to
  aspectName            String              // Specific field name
  
  // Confidence metrics
  confidence            Float               // 0-1 confidence score
  evidenceCount         Int                 @default(0)    // How many evidence points support this
  evidenceQuality       AnalysisQuality     @default(FAIR)  // Quality of evidence
  
  // Supporting evidence
  evidence              Json?               // Evidence that supports this confidence
  reasoning             String?             // AI reasoning for this confidence
  
  // Thresholds for flagging
  isHighConfidence      Boolean             @default(false) // >= 0.8
  isLowConfidence       Boolean             @default(false) // <= 0.3
  requiresReview        Boolean             @default(false) // Flagged for human review
  
  // Timestamps
  createdAt             DateTime            @default(now())
  
  @@unique([analysisId, aspectType, aspectName])
  @@map("analysis_confidence")
}

// Document classification suggestions for intelligent upload
model DocumentClassification {
  id                    String              @id @default(uuid())
  documentId            String              @unique
  document              ContractDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Classification suggestions
  suggestedType         DocumentType
  typeConfidence        Float               @default(0.0)
  
  // Contract association suggestions
  suggestedContractId   String?
  suggestedContract     Contract?           @relation("ClassificationSuggestions", fields: [suggestedContractId], references: [id], onDelete: SetNull)
  contractConfidence    Float               @default(0.0)
  
  // Alternative suggestions
  alternativeTypes      Json                // Array of alternative document types with confidence
  alternativeContracts  Json                // Array of alternative contract matches
  
  // Classification reasoning
  classificationReason  String?             // AI reasoning for classification
  keyIndicators         String[]            // Key indicators that led to classification
  
  // Processing status
  status                ClassificationStatus @default(PENDING)
  reviewRequired        Boolean             @default(false)
  humanReviewed         Boolean             @default(false)
  humanReviewedAt       DateTime?
  humanReviewedBy       String?
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  @@map("document_classifications")
}

// Enhanced Contract model relationships (add to existing Contract model)
// Note: These are additions to be made to the existing Contract model

// Enums
enum SystemType {
  POWER_PURCHASE_STANDARD
  POWER_PURCHASE_WITH_BATTERY
  MICROGRID_CONSTRAINED
  MICROGRID_UNCONSTRAINED
  PP    // Legacy
  MG    // Legacy
  AMG   // Legacy
  OG    // Legacy
  
  @@map("system_type")
}

enum ContractStatus {
  ACTIVE
  DRAFT
  EXPIRED
  CANCELLED
  PENDING
  
  @@map("contract_status")
}

enum VoltageLevel {
  V_208
  V_480
  V_4_16K
  V_13_2K
  V_34_5K
  
  @@map("voltage_level")
}

enum ComponentType {
  RI      // Renewable Integration
  AC      // Advanced Controls
  UC      // Utility Connections
  BESS    // Battery Energy Storage System
  SOLAR   // Solar Integration
  WIND    // Wind Integration
  
  @@map("component_type")
}

enum UploadStatus {
  UPLOADING
  PROCESSING
  COMPLETED
  ERROR
  
  @@map("upload_status")
}

enum AIRole {
  USER
  ASSISTANT
  SYSTEM
  
  @@map("ai_role")
}

enum RuleType {
  RANGE       // Min/max values
  ENUM        // List of valid options
  CORRELATION // Relationships between fields
  VALIDATION  // Validation rules
  CALCULATION // Calculation formulas
  
  @@map("rule_type")
}

enum UserRole {
  ADMIN       // Full system access
  MANAGER     // Can manage contracts and users
  USER        // Can create and edit contracts
  VIEWER      // Read-only access
  
  @@map("user_role")
}

enum DocumentType {
  PRIMARY         // Main contract document
  APPENDIX        // Appendix or attachment
  AMENDMENT       // Contract amendment
  EXHIBIT         // Exhibit or schedule
  ADDENDUM        // Addendum or supplement
  SIGNATURE       // Signature page
  COVER_LETTER    // Cover letter
  OTHER           // Other document type
  
  @@map("document_type")
}

enum ProcessingStatus {
  PENDING         // Not started
  UPLOADING       // Currently uploading
  PROCESSING      // Being processed
  COMPLETED       // Successfully completed
  FAILED          // Failed with error
  CANCELLED       // Cancelled by user
  RETRYING        // Retrying after failure
  
  @@map("processing_status")
}

enum ProcessingJobType {
  CHUNK_UPLOAD        // Process uploaded chunks
  TEXT_EXTRACTION     // Extract text from document
  PAGE_ANALYSIS       // Analyze document pages
  DOCUMENT_MERGE      // Merge document chunks
  OCR_PROCESSING      // OCR text extraction
  CONTENT_INDEXING    // Index content for search
  RULE_EXTRACTION     // Extract business rules
  DOCUMENT_VALIDATION // Validate document content
  CONTRACT_ANALYSIS   // AI-powered contract analysis
  SIMILARITY_ANALYSIS // Document similarity analysis
  
  @@map("processing_job_type")
}

// AI Analysis Quality Levels
enum AnalysisQuality {
  EXCELLENT   // High confidence, clear extraction
  GOOD        // Good confidence, reliable data
  FAIR        // Moderate confidence, some uncertainty
  POOR        // Low confidence, questionable data
  FAILED      // Analysis failed or unusable
  
  @@map("analysis_quality")
}

// Document relationship types
enum DocumentRelation {
  SAME_CONTRACT       // Same contract (duplicate or version)
  AMENDMENT           // Amendment to existing contract
  RELATED_CONTRACT    // Related but separate contract
  APPENDIX            // Appendix or exhibit to main contract
  COVER_LETTER        // Cover letter or supporting document
  UNRELATED          // No meaningful relationship
  REQUIRES_REVIEW    // Relationship unclear, needs human review
  
  @@map("document_relation")
}

// Contract group types
enum ContractGroupType {
  RELATED_CONTRACTS   // Contracts for same client/project
  CONTRACT_FAMILY     // Main contract with amendments/appendices
  DUPLICATE_DETECTION // Potential duplicates requiring review
  TEMPORAL_SEQUENCE   // Contracts in chronological sequence
  MULTI_PARTY         // Complex multi-party agreement
  PROJECT_CONTRACTS   // Contracts for same project/site
  
  @@map("contract_group_type")
}

// Confidence aspect types
enum ConfidenceAspect {
  CONTRACT_TYPE       // Contract type classification
  PARTIES            // Party identification
  DATES              // Date extraction
  FINANCIAL_TERMS    // Financial information
  REFERENCE_NUMBERS  // Contract/PO numbers
  SUBJECT_MATTER     // Content/subject classification
  CRITICAL_CLAUSES   // Important clauses identification
  DOCUMENT_QUALITY   // Overall document quality
  SIMILARITY         // Document similarity assessment
  
  @@map("confidence_aspect")
}

// Document classification status
enum ClassificationStatus {
  PENDING            // Classification not started
  PROCESSING         // Currently being classified
  COMPLETED          // Classification completed
  REVIEW_REQUIRED    // Requires human review
  HUMAN_REVIEWED     // Human has reviewed and confirmed
  FAILED            // Classification failed
  
  @@map("classification_status")
}
